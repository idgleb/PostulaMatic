name: Deploy to Production Server

on:
  push:
    branches: [ master ]
  workflow_dispatch: # Permite ejecutar manualmente

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: Add server to known hosts
      run: |
        ssh-keyscan -H 178.156.188.95 >> ~/.ssh/known_hosts
        
    - name: Deploy to server
      run: |
        ssh deploy@178.156.188.95 << "EOF"
          set -e
          
          echo "ğŸš€ Iniciando despliegue automÃ¡tico..."
          
          # Navegar al directorio del proyecto
          cd /home/deploy/PostulaMatic || {
            echo "âŒ Directorio del proyecto no encontrado. Clonando..."
            git clone https://github.com/idgleb/PostulaMatic.git
            cd PostulaMatic
          }
          
          # Backup de base de datos (si existe)
          echo "ğŸ“¦ Haciendo backup de base de datos..."
          if [ -f ".env" ] && grep -q "DATABASE_URL" .env; then
            source .env
            if command -v pg_dump &> /dev/null && [ ! -z "$DATABASE_URL" ]; then
              pg_dump "$DATABASE_URL" > backup_$(date +%Y%m%d_%H%M%S).sql
              echo "âœ… Backup completado"
            else
              echo "âš ï¸ pg_dump no disponible, saltando backup"
            fi
          fi
          
          # Actualizar cÃ³digo
          echo "ğŸ“¥ Actualizando cÃ³digo desde GitHub..."
          git fetch origin
          git reset --hard origin/master
          
          # Verificar si existe .env
          if [ ! -f ".env" ]; then
            echo "âš ï¸ Archivo .env no encontrado. Creando desde template..."
            cp env.production.example .env
            echo "ğŸ”§ IMPORTANTE: Debes configurar manualmente el archivo .env con tus valores reales"
          fi
          
          # Detener contenedores
          echo "ğŸ›‘ Deteniendo contenedores..."
          docker-compose down || true
          
          # Reconstruir contenedores
          echo "ğŸ”¨ Reconstruyendo contenedores..."
          docker-compose build --no-cache
          
          # Iniciar servicios
          echo "ğŸš€ Iniciando servicios..."
          docker-compose up -d
          
          # Esperar a que los servicios estÃ©n listos
          echo "â³ Esperando a que los servicios estÃ©n listos..."
          sleep 15
          
          # Aplicar migraciones
          echo "ğŸ—„ï¸ Aplicando migraciones..."
          docker-compose exec -T postulamatic_web python manage.py migrate
          
          # Recopilar archivos estÃ¡ticos
          echo "ğŸ“ Recopilando archivos estÃ¡ticos..."
          docker-compose exec -T postulamatic_web python manage.py collectstatic --noinput
          
          # Verificar servicios
          echo "ğŸ” Verificando servicios..."
          
          # Verificar web
          if curl -f -s http://localhost:8000/ > /dev/null; then
            echo "âœ… Servicio web funcionando"
          else
            echo "âŒ Servicio web no responde"
            exit 1
          fi
          
          # Verificar Redis
          if docker-compose exec -T redis redis-cli ping | grep -q "PONG"; then
            echo "âœ… Redis funcionando"
          else
            echo "âŒ Redis no responde"
            exit 1
          fi
          
          # Verificar Celery Worker
          if docker-compose ps worker | grep -q "Up"; then
            echo "âœ… Celery Worker funcionando"
          else
            echo "âŒ Celery Worker no estÃ¡ funcionando"
          fi
          
          # Limpiar imÃ¡genes no utilizadas
          echo "ğŸ§¹ Limpiando imÃ¡genes Docker no utilizadas..."
          docker image prune -f
          
          echo "ğŸ‰ Despliegue completado exitosamente!"
          echo "ğŸ“Š Estado de contenedores:"
          docker-compose ps
        EOF
        
    - name: Notify deployment status
      if: always()
      run: |
        if [ $? -eq 0 ]; then
          echo "âœ… Despliegue exitoso"
        else
          echo "âŒ Despliegue fallÃ³"
        fi
