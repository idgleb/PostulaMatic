{% extends 'matching/base.html' %}

{% block matching_content %}
<!-- Header Section -->
<div class="row mb-5">
    <div class="col-12">
        <div class="text-center">
            <h1 class="display-4 fw-bold mb-3" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                <i class="bi bi-person-circle me-3"></i>Mi Perfil
            </h1>
            <p class="lead text-muted">Configura tu perfil y credenciales para PostulaMatic</p>
        </div>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-12">
        <!-- Configuración SMTP -->
        <div class="card mb-5">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-envelope me-2"></i>Configuración SMTP
                </h5>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'profile' %}" id="smtp-form">
                    {% csrf_token %}
                    <input type="hidden" name="section" value="smtp">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ smtp_form.display_name.id_for_label }}" class="form-label">
                                    Nombre para mostrar
                                </label>
                                {{ smtp_form.display_name }}
                                {% if smtp_form.display_name.errors %}
                                    <div class="text-danger small">{{ smtp_form.display_name.errors.0 }}</div>
                                {% endif %}
                                <div class="form-text">Personalización de emails enviados a empleadores</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ smtp_form.smtp_host.id_for_label }}" class="form-label">
                                    Servidor SMTP
                                </label>
                                {{ smtp_form.smtp_host }}
                                {% if smtp_form.smtp_host.errors %}
                                    <div class="text-danger small">{{ smtp_form.smtp_host.errors.0 }}</div>
                                {% endif %}
                                <div class="form-text">Ej: smtp.gmail.com</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ smtp_form.smtp_port.id_for_label }}" class="form-label">
                                    Puerto
                                </label>
                                {{ smtp_form.smtp_port }}
                                {% if smtp_form.smtp_port.errors %}
                                    <div class="text-danger small">{{ smtp_form.smtp_port.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ smtp_form.smtp_username.id_for_label }}" class="form-label">
                                    Usuario SMTP
                                </label>
                                {{ smtp_form.smtp_username }}
                                {% if smtp_form.smtp_username.errors %}
                                    <div class="text-danger small">{{ smtp_form.smtp_username.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ smtp_form.smtp_password.id_for_label }}" class="form-label">
                                    Contraseña SMTP
                                </label>
                                {{ smtp_form.smtp_password }}
                                {% if smtp_form.smtp_password.errors %}
                                    <div class="text-danger small">{{ smtp_form.smtp_password.errors.0 }}</div>
                                {% endif %}
                                <div class="form-text">⚠️ Se almacena encriptada</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check mb-3">
                                    {{ smtp_form.smtp_use_tls }}
                                    <label for="{{ smtp_form.smtp_use_tls.id_for_label }}" class="form-check-label">
                                        Usar TLS
                                    </label>
                                </div>
                                <div class="form-check">
                                    {{ smtp_form.smtp_use_ssl }}
                                    <label for="{{ smtp_form.smtp_use_ssl.id_for_label }}" class="form-check-label">
                                        Usar SSL
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-end">
                        <button type="submit" name="save_smtp" class="btn btn-success" id="btn-smtp" disabled>
                            <i class="bi bi-envelope-check me-2"></i>Guardar Configuración SMTP
                        </button>
                    </div>
                    <div id="smtp-test-result" class="mt-2" style="display: none;"></div>
                </form>

                <!-- Formulario separado para probar email SMTP -->
                <form method="post" action="{% url 'test_smtp_email' %}" class="mt-3" id="smtp-test-form">
                    {% csrf_token %}
                    <div class="d-flex justify-content-end">
                        <button type="submit" class="btn btn-outline-secondary" id="btn-smtp-test">
                            <i class="bi bi-send-check me-2"></i>Enviar email de prueba
                        </button>
                    </div>
                    <div id="smtp-test-result" class="mt-2" style="display: none;"></div>
                </form>
            </div>
        </div>

        <!-- Credenciales INTRANET DAVINCI -->
        <div class="card mb-5">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-shield-lock me-2"></i>Credenciales INTRANET DAVINCI
                </h5>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'profile' %}" id="dv-form">
                    {% csrf_token %}
                    <input type="hidden" name="section" value="dv">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ dv_form.dv_username.id_for_label }}" class="form-label">
                                    Usuario INTRANET DAVINCI
                                </label>
                                {{ dv_form.dv_username }}
                                {% if dv_form.dv_username.errors %}
                                    <div class="text-danger small">{{ dv_form.dv_username.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ dv_form.dv_password.id_for_label }}" class="form-label">
                                    Contraseña INTRANET DAVINCI
                                </label>
                                {{ dv_form.dv_password }}
                                {% if dv_form.dv_password.errors %}
                                    <div class="text-danger small">{{ dv_form.dv_password.errors.0 }}</div>
                                {% endif %}
                                <div class="form-text">⚠️ Se almacena encriptada</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-end align-items-center">
                        <span id="connection-status" class="me-2" style="display: none;"></span>
                        <button type="submit" name="save_dv" class="btn btn-success" id="btn-dv">
                            <i class="bi bi-shield-check me-2"></i>Conectar a DAVINCI
                        </button>
                    </div>
                </form>

            </div>
        </div>

        <!-- Configuración de Matching -->
        <div class="card mb-5">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up me-2"></i>Configuración de Matching
                    </h5>
                    <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#matchingInfoModal">
                        <i class="bi bi-info-circle me-1"></i>Más información
                    </button>
                </div>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'profile' %}" id="matching-form">
                    {% csrf_token %}
                    <input type="hidden" name="section" value="matching">
                    
                    <!-- Umbral de coincidencia -->
                    <div class="card h-100 mb-4">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-percent text-primary me-3"></i>
                                <label for="{{ matching_form.match_threshold.id_for_label }}" class="form-label mb-0">
                                    Umbral de coincidencia
                                </label>
                                <span class="badge bg-primary ms-3 fs-5" id="threshold-value">{{ matching_form.match_threshold.value|default:profile.match_threshold }}%</span>
                            </div>
                            <div class="d-flex align-items-center">
                                {{ matching_form.match_threshold }}
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle me-1"></i>
                                    <strong>¿Qué es?</strong> Porcentaje mínimo de coincidencia entre tu CV y una oferta para enviar email automático.
                                    <br>
                                    <strong>Recomendado:</strong> 50-70% para balance entre precisión y oportunidades.
                                    <br>
                                    <strong>Ejemplo:</strong> Con 60%, solo se enviarán emails si hay al menos 60% de coincidencia de habilidades.
                                </small>
                            </div>
                            {% if matching_form.match_threshold.errors %}
                                <div class="text-danger small">{{ matching_form.match_threshold.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    
                    <div class="d-flex justify-content-end">
                        <button type="submit" name="save_matching" class="btn btn-success" id="btn-matching" disabled>
                            <i class="bi bi-gear me-2"></i>Guardar Configuración de Matching
                        </button>
                    </div>
                    <div id="matching-result" class="mt-2" style="display: none;"></div>
                </form>
            </div>
        </div>

        <!-- Configuración de Envíos de Emails -->
        <div class="card mb-5">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-send me-2"></i>Configuración de Envíos de Emails
                </h5>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'profile' %}" id="email-form">
                    {% csrf_token %}
                    <input type="hidden" name="section" value="email">
                    
                    <!-- Límite diario de emails -->
                    <div class="card h-100 mb-4">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-envelope-check text-primary me-3"></i>
                                <label for="{{ email_form.daily_limit.id_for_label }}" class="form-label mb-0">
                                    Límite diario de emails
                                </label>
                                <span class="badge bg-primary ms-3 fs-5" id="limit-value">{{ email_form.daily_limit.value|default:10 }}</span>
                            </div>
                            <div class="d-flex align-items-center">
                                {{ email_form.daily_limit }}
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle me-1"></i>
                                    <strong>¿Qué es?</strong> Número máximo de emails que se enviarán por día para evitar spam.
                                    <br>
                                    <strong>Recomendado:</strong> 5-15 emails por día para mantener profesionalismo.
                                    <br>
                                    <strong>Importante:</strong> Respetar límites evita que tu cuenta sea marcada como spam.
                                </small>
                            </div>
                            {% if email_form.daily_limit.errors %}
                                <div class="text-danger small">{{ email_form.daily_limit.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Pausas (mínima y máxima en una fila) -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card h-100 mb-4">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="bi bi-clock text-primary me-3"></i>
                                        <label for="{{ email_form.min_pause_seconds.id_for_label }}" class="form-label mb-0">
                                            Pausa mínima (segundos)
                                        </label>
                                        <span class="badge bg-primary ms-3 fs-5" id="min-pause-value">{{ email_form.min_pause_seconds.value|default:30 }}s</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        {{ email_form.min_pause_seconds }}
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            <i class="bi bi-info-circle me-1"></i>
                                            <strong>¿Qué es?</strong> Tiempo mínimo de espera entre envío de emails para simular comportamiento humano.
                                            <br>
                                            <strong>Recomendado:</strong> 30-60 segundos para evitar detección de automatización.
                                        </small>
                                    </div>
                                    {% if email_form.min_pause_seconds.errors %}
                                        <div class="text-danger small">{{ email_form.min_pause_seconds.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card h-100 mb-4">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="bi bi-clock-history text-primary me-3"></i>
                                        <label for="{{ email_form.max_pause_seconds.id_for_label }}" class="form-label mb-0">
                                            Pausa máxima (segundos)
                                        </label>
                                        <span class="badge bg-primary ms-3 fs-5" id="max-pause-value">{{ email_form.max_pause_seconds.value|default:120 }}s</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        {{ email_form.max_pause_seconds }}
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            <i class="bi bi-info-circle me-1"></i>
                                            <strong>¿Qué es?</strong> Tiempo máximo de espera entre envío de emails para variar el comportamiento.
                                            <br>
                                            <strong>Recomendado:</strong> 120-300 segundos para mayor naturalidad.
                                        </small>
                                    </div>
                                    {% if email_form.max_pause_seconds.errors %}
                                        <div class="text-danger small">{{ email_form.max_pause_seconds.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Explicación adicional para las pausas -->
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Importante sobre las pausas:</strong> El sistema elegirá un tiempo aleatorio entre la pausa mínima y máxima para cada email. Esto hace que los envíos parezcan más naturales y evita la detección de automatización. La pausa máxima debe ser mayor que la mínima.
                    </div>
                    
                    <div class="d-flex justify-content-end">
                        <button type="submit" name="save_email" class="btn btn-success" id="btn-email" disabled>
                            <i class="bi bi-send me-2"></i>Guardar Configuración de Envíos
                        </button>
                    </div>
                    <div id="email-result" class="mt-2" style="display: none;"></div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Modal de información sobre Matching - Reutilizable -->
{% include 'matching/partials/matching_info_modal.html' %}
<script>
(function() {
    'use strict';
    
    // Variables locales para formularios
    let smtpForm, dvForm, matchingForm, emailForm;
    
    // Variable para controlar si los campos DV han sido modificados
    let dvFieldsModified = false;

    // Función para activar/desactivar botones
    function updateButtonStates() {
        // Activar botón SMTP si hay cambios
        const smtpBtn = document.getElementById('btn-smtp');
        if (smtpForm && smtpBtn) {
            const smtpInputs = smtpForm.querySelectorAll('input, select');
            smtpInputs.forEach(input => {
                // Remover event listeners existentes para evitar duplicados
                input.removeEventListener('input', handleSmtpInput);
                input.addEventListener('input', handleSmtpInput);
            });
        }

        // Activar botón DV si hay cambios
        const dvBtn = document.getElementById('btn-dv');
        if (dvForm && dvBtn) {
            const dvInputs = dvForm.querySelectorAll('input');
            dvInputs.forEach(input => {
                // Remover event listeners existentes para evitar duplicados
                input.removeEventListener('input', handleDvInput);
                input.addEventListener('input', handleDvInput);
            });
        }

        // Activar botón Matching si hay cambios
        const matchingBtn = document.getElementById('btn-matching');
        if (matchingForm && matchingBtn) {
            const matchingInputs = matchingForm.querySelectorAll('input');
            matchingInputs.forEach(input => {
                // Remover event listeners existentes para evitar duplicados
                input.removeEventListener('input', handleMatchingInput);
                input.addEventListener('input', handleMatchingInput);
            });
        }

        // Activar botón Email si hay cambios
        const emailBtn = document.getElementById('btn-email');
        if (emailForm && emailBtn) {
            const emailInputs = emailForm.querySelectorAll('input');
            emailInputs.forEach(input => {
                // Remover event listeners existentes para evitar duplicados
                input.removeEventListener('input', handleEmailInput);
                input.addEventListener('input', handleEmailInput);
            });
        }
    }

    // Funciones separadas para manejar inputs
    function handleSmtpInput() {
        const smtpBtn = document.getElementById('btn-smtp');
        if (smtpBtn) smtpBtn.disabled = false;
    }

     function handleDvInput() {
         // Marcar que los campos han sido modificados
         dvFieldsModified = true;
         console.log('Campos DV modificados - desactivando actualizaciones automáticas');
         
         const dvBtn = document.getElementById('btn-dv');
         if (dvBtn) {
             // Restaurar botón a estado inicial solo si estaba verificada o en proceso
             if (isConnectionVerified || isConnectionInProgress) {
                 dvBtn.innerHTML = '<i class="bi bi-shield-check me-2"></i>Conectar a DAVINCI';
                 dvBtn.disabled = false;
                 showConnectionStatus(false);
                 // Resetear estados al cambiar campos
                 setConnectionVerifiedState(false);
             } else {
                 dvBtn.disabled = false;
             }
         }
     }

    function handleMatchingInput() {
        const matchingBtn = document.getElementById('btn-matching');
        if (matchingBtn) matchingBtn.disabled = false;
    }

    function handleEmailInput() {
        const emailBtn = document.getElementById('btn-email');
        if (emailBtn) emailBtn.disabled = false;
    }

    // Actualizar valores de sliders en tiempo real
    function updateSliderValues() {
        const thresholdSlider = document.querySelector('input[name="match_threshold"]');
        const limitSlider = document.querySelector('input[name="daily_limit"]');
        const minPauseSlider = document.querySelector('input[name="min_pause_seconds"]');
        const maxPauseSlider = document.querySelector('input[name="max_pause_seconds"]');

        if (thresholdSlider) {
            thresholdSlider.addEventListener('input', function() {
                const thresholdValue = document.getElementById('threshold-value');
                if (thresholdValue) {
                    thresholdValue.textContent = this.value + '%';
                }
            });
        }

        if (limitSlider) {
            limitSlider.addEventListener('input', function() {
                const limitValue = document.getElementById('limit-value');
                if (limitValue) {
                    limitValue.textContent = this.value;
                }
            });
        }

        if (minPauseSlider) {
            minPauseSlider.addEventListener('input', function() {
                const minPauseValue = document.getElementById('min-pause-value');
                if (minPauseValue) {
                    minPauseValue.textContent = this.value + 's';
                }
            });
        }

        if (maxPauseSlider) {
            maxPauseSlider.addEventListener('input', function() {
                const maxPauseValue = document.getElementById('max-pause-value');
                if (maxPauseValue) {
                    maxPauseValue.textContent = this.value + 's';
                }
            });
        }
    }

    // Manejar envío de formularios con AJAX
    function setupFormHandlers() {
        // SMTP Form
        if (smtpForm) {
            smtpForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Validar contraseña SMTP
                const smtpPassword = document.getElementById('id_smtp_password');
                if (smtpPassword && (!smtpPassword.value || smtpPassword.value.trim() === '')) {
                    showMessage('smtp-test-result', '❌ La contraseña SMTP es obligatoria.', 'error');
                    return;
                }
                
                // Desactivar botón y mostrar spinner
                const btn = document.getElementById('btn-smtp');
                if (btn) {
                    // Usar texto hardcodeado para evitar problemas con el estado previo del botón
                    const originalText = '<i class="bi bi-envelope-check me-2"></i>Guardar Configuración SMTP';
                    console.log('SMTP - Texto original hardcodeado:', originalText);
                    btn.disabled = true;
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" style="color: white !important; border-color: white !important; border-top-color: transparent !important; opacity: 1 !important;" role="status" aria-hidden="true"></span>Conectando...';
                    
                    const formData = new FormData(this);
                    
                    fetch(this.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('SMTP - Restaurando texto original:', originalText);
                        btn.innerHTML = originalText;
                        if (data.success) {
                            btn.disabled = true; // Desactivar después de guardado exitoso
                            showMessage('smtp-test-result', data.message, 'success');
                        } else {
                            btn.disabled = false; // Reactivar si hay error
                            showMessage('smtp-test-result', data.message, 'error');
                        }
                    })
                    .catch(error => {
                        btn.innerHTML = originalText;
                        btn.disabled = false; // Reactivar si hay error de conexión
                        showMessage('smtp-test-result', 'Error de conexión: ' + error.message, 'error');
                    });
                }
            });
        }

        // SMTP Test Form
        const smtpTestForm = document.getElementById('smtp-test-form');
        if (smtpTestForm) {
            smtpTestForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Desactivar botón y mostrar spinner
                const btn = document.getElementById('btn-smtp-test');
                if (btn) {
                    // Usar texto hardcodeado para evitar problemas con el estado previo del botón
                    const originalText = '<i class="bi bi-send-check me-2"></i>Enviar email de prueba';
                    btn.disabled = true;
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Enviando...';
                    
                    const formData = new FormData(this);
                    
                    fetch(this.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showMessage('smtp-test-result', data.message, 'success');
                        } else {
                            showMessage('smtp-test-result', data.message, 'error');
                        }
                    })
                    .catch(error => {
                        showMessage('smtp-test-result', 'Error de conexión: ' + error.message, 'error');
                    })
                    .finally(() => {
                        if (btn) {
                            btn.disabled = false;
                            btn.innerHTML = originalText;
                        }
                    });
                }
            });
        }

        // DV Form
        if (dvForm) {
            dvForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Validar contraseña INTRANET DAVINCI
                const dvPassword = document.getElementById('id_dv_password');
                if (dvPassword && (!dvPassword.value || dvPassword.value.trim() === '')) {
                    // Solo ocultar tilde verde visualmente, NO cambiar estado persistente
                    showConnectionStatus(false);
                    const btn = document.getElementById('btn-dv');
                    if (btn) {
                        btn.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Contraseña obligatoria';
                        setTimeout(() => {
                            if (!isConnectionVerified) {
                                btn.innerHTML = '<i class="bi bi-shield-check me-2"></i>Conectar a DAVINCI';
                            }
                        }, 2000);
                    }
                    return;
                }
                
                // Resetear la variable de campos modificados al iniciar el proceso
                dvFieldsModified = false;
                console.log('Iniciando proceso DV - reactivando actualizaciones automáticas');
                
                // Desactivar botón y mostrar spinner
                const btn = document.getElementById('btn-dv');
                if (btn) {
                    // Establecer estado "en proceso" al iniciar
                    setConnectionVerifiedState(null); // null = in_progress
                    
                    // Usar texto hardcodeado para evitar problemas con el estado previo del botón
                    const originalText = '<i class="bi bi-shield-check me-2"></i>Conectar a DAVINCI';
                    btn.disabled = true;
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" style="color: white !important; border-color: white !important; border-top-color: transparent !important; opacity: 1 !important;" role="status" aria-hidden="true"></span>Conectando...';
                    
                    const formData = new FormData(this);
                    
                    fetch(this.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Cambiar botón a estado de verificación automática
                            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" style="color: white !important; border-color: white !important; border-top-color: transparent !important; opacity: 1 !important;" role="status" aria-hidden="true"></span>Verificando conexión...';
                            btn.disabled = true;
                            
                            // Ejecutar automáticamente la prueba de conexión
                            autoTestDVConnection();
                        } else {
                            // Solo ocultar tilde verde visualmente, NO cambiar estado persistente
                            showConnectionStatus(false);
                            // Mostrar error en el botón brevemente
                            btn.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Error: ' + data.message.substring(0, 30) + '...';
                            btn.disabled = false;
                            
                            // Restaurar después de 3 segundos solo si no estaba previamente verificada
                            setTimeout(() => {
                                if (!isConnectionVerified) {
                                    btn.innerHTML = originalText;
                                }
                            }, 3000);
                        }
                    })
                    .catch(error => {
                        // Solo ocultar tilde verde visualmente, NO cambiar estado persistente
                        showConnectionStatus(false);
                        // Mostrar error en el botón brevemente
                        btn.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Error de conexión';
                        btn.disabled = false;
                        
                        // Restaurar después de 3 segundos solo si no estaba previamente verificada
                        setTimeout(() => {
                            if (!isConnectionVerified) {
                                btn.innerHTML = originalText;
                            }
                        }, 3000);
                    });
                }
            });
        }


        // Matching Form
        if (matchingForm) {
            matchingForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Desactivar botón y mostrar spinner
                const btn = document.getElementById('btn-matching');
                if (btn) {
                    // Usar texto hardcodeado para evitar problemas con el estado previo del botón
                    const originalText = '<i class="bi bi-gear me-2"></i>Guardar Configuración de Matching';
                    btn.disabled = true;
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" style="color: white !important; border-color: white !important; border-top-color: transparent !important; opacity: 1 !important;" role="status" aria-hidden="true"></span>Conectando...';
                    
                    const formData = new FormData(this);
                    
                    fetch(this.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        btn.innerHTML = originalText;
                        if (data.success) {
                            btn.disabled = true; // Desactivar después de guardado exitoso
                            showMessage('matching-result', data.message, 'success');
                        } else {
                            btn.disabled = false; // Reactivar si hay error
                            showMessage('matching-result', data.message, 'error');
                        }
                    })
                    .catch(error => {
                        btn.innerHTML = originalText;
                        btn.disabled = false; // Reactivar si hay error de conexión
                        showMessage('matching-result', 'Error de conexión: ' + error.message, 'error');
                    });
                }
            });
        }

        // Email Form
        if (emailForm) {
            emailForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Desactivar botón y mostrar spinner
                const btn = document.getElementById('btn-email');
                if (btn) {
                    // Usar texto hardcodeado para evitar problemas con el estado previo del botón
                    const originalText = '<i class="bi bi-send me-2"></i>Guardar Configuración de Envíos';
                    btn.disabled = true;
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" style="color: white !important; border-color: white !important; border-top-color: transparent !important; opacity: 1 !important;" role="status" aria-hidden="true"></span>Conectando...';
                    
                    const formData = new FormData(this);
                    
                    fetch(this.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        btn.innerHTML = originalText;
                        if (data.success) {
                            btn.disabled = true; // Desactivar después de guardado exitoso
                            showMessage('email-result', data.message, 'success');
                        } else {
                            btn.disabled = false; // Reactivar si hay error
                            showMessage('email-result', data.message, 'error');
                        }
                    })
                    .catch(error => {
                        btn.innerHTML = originalText;
                        btn.disabled = false; // Reactivar si hay error de conexión
                        showMessage('email-result', 'Error de conexión: ' + error.message, 'error');
                    });
                }
            });
        }
    }

    // Función para mostrar mensajes
    function showMessage(containerId, message, type) {
        const container = document.getElementById(containerId);
        if (container) {
            let alertClass = 'alert-danger'; // Por defecto
            if (type === 'success') {
                alertClass = 'alert-success';
            } else if (type === 'info') {
                alertClass = 'alert-info';
            } else if (type === 'warning') {
                alertClass = 'alert-warning';
            }
            
            container.innerHTML = '<div class="alert ' + alertClass + '">' + message + '</div>';
            container.style.display = 'block';
        }
    }

    // Variable para mantener el estado de verificación desde la base de datos
    let isConnectionVerified = {{ profile.is_dv_connection_verified|yesno:"true,false" }};
    let isConnectionInProgress = {{ profile.is_dv_connection_in_progress|yesno:"true,false" }};
    console.log('Estado de conexión DV desde la base de datos:', isConnectionVerified);
    console.log('Estado en proceso desde la base de datos:', isConnectionInProgress);
    console.log('Valor crudo del template:', '{{ profile.is_dv_connection_verified }}');
    console.log('Valor dv_connection_status:', '{{ profile.dv_connection_status }}');

    // Función para mostrar indicador de conexión (solo visual, no cambia el estado persistente)
    function showConnectionStatus(success) {
        const statusElement = document.getElementById('connection-status');
        if (statusElement) {
            if (success) {
                statusElement.innerHTML = '<i class="bi bi-check-circle-fill text-success" style="font-size: 1.5rem;"></i>';
                statusElement.style.display = 'inline-block';
                // NO cambiar isConnectionVerified aquí - solo mostrar visualmente
            } else {
                statusElement.style.display = 'none';
                // NO cambiar isConnectionVerified aquí - solo ocultar visualmente
            }
        }
    }

    // Función separada para establecer el estado persistente de verificación
    function setConnectionVerifiedState(verified) {
        if (verified === true) {
            isConnectionVerified = true;
            isConnectionInProgress = false;
            console.log('Estado de verificación DV: VERIFICADO');
        } else if (verified === false) {
            isConnectionVerified = false;
            isConnectionInProgress = false;
            console.log('Estado de verificación DV: NO VERIFICADO');
        } else { // null, undefined, o 'in_progress'
            isConnectionVerified = false;
            isConnectionInProgress = true;
            console.log('Estado de verificación DV: EN PROCESO');
        }
    }


    // Función para ejecutar automáticamente la prueba de conexión DV
    function autoTestDVConnection() {
        const btn = document.getElementById('btn-dv');
        
        if (!btn) {
            console.error('Botón DV no encontrado');
            return;
        }
        
        // Crear FormData para la prueba
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        // Ejecutar la prueba directamente a la URL de test_dv_login
        fetch('{% url "test_dv_login" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                btn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Credenciales verificadas';
                btn.disabled = true;
                // Actualizar estado persistente y mostrar tilde verde
                setConnectionVerifiedState(true);
                showConnectionStatus(true);
            } else {
                // Solo ocultar tilde verde visualmente, NO cambiar estado persistente
                showConnectionStatus(false);
                // Mostrar error en el botón brevemente
                btn.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Error: ' + data.message.substring(0, 30) + '...';
                btn.disabled = false;
                
                // Restaurar después de 3 segundos solo si no estaba previamente verificada
                setTimeout(() => {
                    if (!isConnectionVerified) {
                        btn.innerHTML = '<i class="bi bi-shield-check me-2"></i>Conectar a DAVINCI';
                    }
                }, 3000);
            }
        })
        .catch(error => {
            console.error('Error en prueba automática DV:', error);
            // Solo ocultar tilde verde visualmente, NO cambiar estado persistente
            showConnectionStatus(false);
            // Mostrar error en el botón brevemente
            btn.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Error de conexión';
            btn.disabled = false;
            
            // Restaurar después de 3 segundos solo si no estaba previamente verificada
            setTimeout(() => {
                if (!isConnectionVerified) {
                    btn.innerHTML = '<i class="bi bi-shield-check me-2"></i>Conectar a DAVINCI';
                }
            }, 3000);
        });
    }

    // Función para verificar si las credenciales ya están verificadas al cargar la página
    function checkInitialVerificationStatus() {
        console.log('Verificando estado inicial de conexión DV:', isConnectionVerified);
        console.log('Estado en proceso:', isConnectionInProgress);
        const btn = document.getElementById('btn-dv');
        if (!btn) {
            console.error('Botón DV no encontrado al verificar estado inicial');
            return;
        }
        
        if (isConnectionVerified) {
            // Si está verificada según la base de datos, mostrar el estado verificado
            console.log('Credenciales verificadas - aplicando estado verificado');
            btn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Credenciales verificadas';
            btn.disabled = true;
            showConnectionStatus(true);
        } else if (isConnectionInProgress) {
            // Si está en proceso, mostrar estado de verificación
            console.log('Credenciales en proceso - aplicando estado de verificación');
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" style="color: white !important; border-color: white !important; border-top-color: transparent !important; opacity: 1 !important;" role="status" aria-hidden="true"></span>Verificando conexión...';
            btn.disabled = true;
            showConnectionStatus(false);
        } else {
            // Si no está verificada, asegurar que esté en estado inicial
            console.log('Credenciales no verificadas - aplicando estado inicial');
            btn.innerHTML = '<i class="bi bi-shield-check me-2"></i>Conectar a DAVINCI';
            btn.disabled = false;
            showConnectionStatus(false);
        }
    }

    // Inicializar cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar formularios
        smtpForm = document.getElementById('smtp-form');
        dvForm = document.getElementById('dv-form');
        matchingForm = document.getElementById('matching-form');
        emailForm = document.getElementById('email-form');
        
        updateButtonStates();
        updateSliderValues();
        setupFormHandlers();
        
        // Verificar estado inicial de verificación inmediatamente
        checkInitialVerificationStatus();
        
        // Función para actualizar el estado de conexión DV dinámicamente
        function updateDVConnectionStatusFromServer() {
            // No actualizar si los campos han sido modificados
            if (dvFieldsModified) {
                console.log('Campos DV modificados - saltando actualización automática desde servidor');
                return;
            }
            
            fetch('{% url "dv_connection_status" %}', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('Estado DV actualizado desde servidor:', data);
                
                // Actualizar variables globales
                isConnectionVerified = data.credentials_verified;
                isConnectionInProgress = data.credentials_in_progress;
                
                // Actualizar botón y checkmark según el estado
                const btn = document.getElementById('btn-dv');
                if (btn) {
                    if (data.credentials_verified) {
                        btn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Credenciales verificadas';
                        btn.disabled = true;
                        showConnectionStatus(true);
                    } else if (data.credentials_in_progress) {
                        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" style="color: white !important; border-color: white !important; border-top-color: transparent !important; opacity: 1 !important;" role="status" aria-hidden="true"></span>Verificando conexión...';
                        btn.disabled = true;
                        showConnectionStatus(false);
                    } else {
                        btn.innerHTML = '<i class="bi bi-shield-check me-2"></i>Conectar a DAVINCI';
                        btn.disabled = false;
                        showConnectionStatus(false);
                    }
                }
            })
            .catch(error => {
                console.error('Error actualizando estado de conexión DV desde servidor:', error);
            });
        }
        
        // Actualizar estado cada 2 segundos
        setInterval(updateDVConnectionStatusFromServer, 2000);
    });
})();
</script>
{% endblock %}
